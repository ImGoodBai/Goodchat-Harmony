import llmService from '../services/LlmService';
import imageService from '../services/ImageService';
import searchService from '../services/SearchService';
import ChatMessage from '../models/ChatMessage';

@Entry
@Component
struct Index {
  @State inputText: string = '';
  @State title: string = 'æ™ºèƒ½åŠ©æ‰‹';
  @State isLoading: boolean = false;
  @State errorMessage: string = '';
  @State chatMessages: ChatMessage[] = [];
  @State showChat: boolean = false;
  @State modelType: string = 'chat'; // 'chat', 'image' æˆ– 'search'
  @State imageUrl: string = '';

  /**
   * è·å–å½“å‰æ¨¡å¼çš„å›¾æ ‡
   */
  getModelIcon(): string {
    switch (this.modelType) {
      case 'chat':
        return 'ğŸ¤–'; // æœºå™¨äºº
      case 'image':
        return 'ğŸ¨'; // ç”»ç¬”
      case 'search':
        return 'ğŸ”'; // æ”¾å¤§é•œ
      default:
        return 'ğŸ¤–';
    }
  }
  
  /**
   * è·å–å½“å‰æ¨¡å¼çš„æ ‡é¢˜
   */
  getModelTitle(): string {
    switch (this.modelType) {
      case 'chat':
        return 'ä¸æ™ºèƒ½åŠ©æ‰‹å¯¹è¯';
      case 'image':
        return 'ç”ŸæˆAIå›¾åƒ';
      case 'search':
        return 'å®æ—¶æœç´¢ä¿¡æ¯';
      default:
        return 'ä¸æ™ºèƒ½åŠ©æ‰‹å¯¹è¯';
    }
  }
  
  /**
   * è·å–è¾“å…¥æ¡†æç¤ºæ–‡æœ¬
   */
  getInputPlaceholder(): string {
    switch (this.modelType) {
      case 'chat':
        return 'è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...';
      case 'image':
        return 'è¯·è¾“å…¥å›¾åƒæè¿°...';
      case 'search':
        return 'è¯·è¾“å…¥æœç´¢å†…å®¹...';
      default:
        return 'è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...';
    }
  }
  
  /**
   * è·å–æŒ‰é’®æ–‡æœ¬
   */
  getButtonText(): string {
    switch (this.modelType) {
      case 'chat':
        return 'å‘é€';
      case 'image':
        return 'ç”Ÿæˆ';
      case 'search':
        return 'æœç´¢';
      default:
        return 'å‘é€';
    }
  }

  build() {
    Column() {
      // å†…å®¹åŒºåŸŸé™åˆ¶æœ€å¤§å®½åº¦
      Column() {
        // æ ‡é¢˜åŒºåŸŸå’Œæ¨¡å‹åˆ‡æ¢
        Row() {
          Text(this.title)
            .id('Title')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
          
          Blank()
          
          // æ¨¡å‹åˆ‡æ¢æŒ‰é’®
          Row() {
            Radio({ value: 'chat', group: 'modelType' })
              .checked(this.modelType === 'chat')
              .onChange((isChecked: boolean) => {
                if (isChecked) {
                  this.modelType = 'chat';
                }
              })
            Text('èŠå¤©')
              .fontSize(16)
              .margin({ right: 10 })
            
            Radio({ value: 'image', group: 'modelType' })
              .checked(this.modelType === 'image')
              .onChange((isChecked: boolean) => {
                if (isChecked) {
                  this.modelType = 'image';
                }
              })
            Text('ç”»å›¾')
              .fontSize(16)
              .margin({ right: 10 })
              
            Radio({ value: 'search', group: 'modelType' })
              .checked(this.modelType === 'search')
              .onChange((isChecked: boolean) => {
                if (isChecked) {
                  this.modelType = 'search';
                }
              })
            Text('æœç´¢')
              .fontSize(16)
          }
          .width('auto')
        }
        .width('100%')
        .margin({ top: 20, bottom: 20 })

        if (!this.showChat) {
          // é¦–é¡µæœç´¢ç•Œé¢
          Column() {
            // ä½¿ç”¨æ–‡æœ¬æ›¿ä»£å›¾æ ‡
            Text(this.getModelIcon())
              .fontSize(80)
              .margin({ top: 80, bottom: 40 })

            Text(this.getModelTitle())
              .fontSize(24)
              .fontWeight(FontWeight.Medium)
              .margin({ bottom: 60 })

            Row() {
              TextInput({ placeholder: this.getInputPlaceholder() })
                .width('70%')
                .height(50)
                .borderRadius(25)
                .backgroundColor('#f5f5f5')
                .padding({ left: 20, right: 20 })
                .onChange((value: string) => {
                  this.inputText = value;
                })

              Button() {
                Row() {
                  if (this.isLoading) {
                    LoadingProgress()
                      .width(20)
                      .height(20)
                      .color(Color.White)
                  } else {
                    Text(this.getButtonText())
                      .fontColor(Color.White)
                  }
                }
              }
              .width('15%')
              .height(50)
              .borderRadius(25)
              .backgroundColor('#1976D2')
              .margin({ left: 10 })
              .onClick(() => {
                this.sendMessage();
              })
            }
            .width('90%')
            .justifyContent(FlexAlign.Center)
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Start)
          .alignItems(HorizontalAlign.Center)
        } else {
          // èŠå¤©ç•Œé¢
          Column() {
            // èŠå¤©æ¶ˆæ¯åŒºåŸŸ
            Scroll() {
              Column() {
                ForEach(this.chatMessages, (message: ChatMessage) => {
                  // æ ¹æ®æ¶ˆæ¯ç±»å‹æ˜¾ç¤ºä¸åŒæ ·å¼
                  if (message.type === 'user') {
                    // ç”¨æˆ·æ¶ˆæ¯ - å³ä¾§
                    Row() {
                      Column() {
                        Text(message.content)
                          .fontSize(16)
                          .backgroundColor('#DCF8C6')
                          .padding(15)
                          .borderRadius(10)
                          .width('100%')
                      }
                      .alignItems(HorizontalAlign.End)
                      .width('80%')
                    }
                    .width('100%')
                    .justifyContent(FlexAlign.End)
                    .margin({ top: 10, bottom: 10 })
                  } else if (message.type === 'assistant') {
                    // AIæ–‡æœ¬å›å¤ - å·¦ä¾§
                    Row() {
                      Column() {
                        Text(message.content)
                          .fontSize(16)
                          .padding(15)
                          .borderRadius(10)
                          .width('100%')
                      }
                      .alignItems(HorizontalAlign.Start)
                      .width('80%')
                    }
                    .width('100%')
                    .justifyContent(FlexAlign.Start)
                    .margin({ top: 10, bottom: 10 })
                  } else if (message.type === 'image') {
                    // AIå›¾åƒå›å¤ - å³ä¾§
                    Row() {
                      Column() {
                        if (message.content.startsWith('http')) {
                          Image(message.content)
                            .width('100%')
                            .aspectRatio(1)
                            .objectFit(ImageFit.Cover)
                            .borderRadius(10)
                        } else {
                          Text(message.content)
                            .fontSize(16)
                            .backgroundColor('#EAEAEA')
                            .padding(15)
                            .borderRadius(10)
                            .width('100%')
                        }
                      }
                      .alignItems(HorizontalAlign.Start)
                      .width('80%')
                    }
                    .width('100%')
                    .justifyContent(FlexAlign.End)
                    .margin({ top: 10, bottom: 10 })
                  }
                })

                // åŠ è½½ä¸­æŒ‡ç¤ºå™¨
                if (this.isLoading) {
                  Row() {
                    LoadingProgress()
                      .width(24)
                      .height(24)
                      .color('#1976D2')
                    Text('æ­£åœ¨æ€è€ƒ...')
                      .fontSize(14)
                      .fontColor('#666666')
                      .margin({ left: 10 })
                  }
                  .width('100%')
                  .justifyContent(FlexAlign.Start)
                  .padding({ left: 20 })
                  .margin({ top: 10, bottom: 10 })
                }
              }
              .width('90%')
              .padding(10)
            }
            .scrollBar(BarState.Auto)
            .scrollBarColor(Color.Gray)
            .scrollBarWidth(4)
            .edgeEffect(EdgeEffect.Spring)
            .width('100%')
            .height('85%')

            // é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
            if (this.errorMessage !== '') {
              Text(this.errorMessage)
                .fontSize(14)
                .fontColor(Color.Red)
                .width('90%')
                .margin({ top: 5, bottom: 5 })
            }

            // åº•éƒ¨è¾“å…¥åŒº
            Row() {
              TextInput({ placeholder: 'è¾“å…¥æ¶ˆæ¯...' })
                .width('75%')
                .height(50)
                .borderRadius(25)
                .backgroundColor('#f5f5f5')
                .padding({ left: 20, right: 20 })
                .onChange((value: string) => {
                  this.inputText = value;
                })

              Button() {
                Row() {
                  if (this.isLoading) {
                    LoadingProgress()
                      .width(20)
                      .height(20)
                      .color(Color.White)
                  } else {
                    Text('å‘é€')
                      .fontColor(Color.White)
                  }
                }
              }
              .width('15%')
              .height(50)
              .borderRadius(25)
              .backgroundColor('#1976D2')
              .margin({ left: 10 })
              .onClick(() => {
                this.sendMessage();
              })
            }
            .width('90%')
            .justifyContent(FlexAlign.Center)
            .margin({ top: 10 })
          }
          .width('100%')
          .height('100%')
        }
      }
      .width('100%')
      .maxWidth('900px')
      .alignSelf(ItemAlign.Center)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#ffffff')
  }

  /**
   * å‘é€æ¶ˆæ¯å¹¶è·å–AIå›å¤
   */
  async sendMessage() {
    if (this.inputText.trim() === '') {
      this.errorMessage = this.getInputPlaceholder();
      return;
    }

    try {
      // è®¾ç½®çŠ¶æ€
      this.isLoading = true;
      this.errorMessage = '';
      
      // åˆ›å»ºç”¨æˆ·æ¶ˆæ¯
      const userMessage = new ChatMessage(this.inputText, 'user');
      
      // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œåˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
      if (this.chatMessages.length === 0) {
        this.showChat = true;
      }
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      this.chatMessages.push(userMessage);
      
      // æ¸…ç©ºè¾“å…¥æ¡†
      this.inputText = '';

      // æ ¹æ®æ¨¡å‹ç±»å‹è°ƒç”¨ä¸åŒçš„æœåŠ¡
      switch (this.modelType) {
        case 'chat':
          // è°ƒç”¨LLMæœåŠ¡
          const chatResponse = await llmService.queryLlm(userMessage.content);
          
          // åˆ›å»ºAIå›å¤æ¶ˆæ¯
          const aiMessage = new ChatMessage(chatResponse, 'assistant');
          
          // æ·»åŠ AIå›å¤
          this.chatMessages.push(aiMessage);
          break;
          
        case 'image':
          // è°ƒç”¨ç”»å›¾æœåŠ¡
          const loadingMessage = new ChatMessage('æ­£åœ¨ç”Ÿæˆå›¾åƒ...', 'image');
          this.chatMessages.push(loadingMessage);
          
          // è°ƒç”¨å›¾åƒç”ŸæˆæœåŠ¡
          const imageUrl = await imageService.generateImage(userMessage.content);
          
          // ç§»é™¤åŠ è½½ä¸­æ¶ˆæ¯
          this.chatMessages.pop();
          
          // åˆ›å»ºAIå›¾åƒå›å¤æ¶ˆæ¯
          const imageMessage = new ChatMessage(imageUrl, 'image');
          
          // æ·»åŠ AIå›¾åƒå›å¤
          this.chatMessages.push(imageMessage);
          break;
          
        case 'search':
          // è°ƒç”¨æœç´¢æœåŠ¡
          const searchLoadingMessage = new ChatMessage('æ­£åœ¨æœç´¢ä¿¡æ¯...', 'assistant');
          this.chatMessages.push(searchLoadingMessage);
          
          // è°ƒç”¨æœç´¢æœåŠ¡
          const searchResponse = await searchService.search(userMessage.content);
          
          // ç§»é™¤åŠ è½½ä¸­æ¶ˆæ¯
          this.chatMessages.pop();
          
          // åˆ›å»ºæœç´¢ç»“æœæ¶ˆæ¯
          const searchResultMessage = new ChatMessage(searchResponse, 'assistant');
          
          // æ·»åŠ æœç´¢ç»“æœ
          this.chatMessages.push(searchResultMessage);
          break;
      }
    } catch (error) {
      this.errorMessage = `æŸ¥è¯¢å¤±è´¥: ${error}`;
      console.error(`APIè°ƒç”¨å¤±è´¥: ${error}`);
    } finally {
      this.isLoading = false;
    }
  }
}
