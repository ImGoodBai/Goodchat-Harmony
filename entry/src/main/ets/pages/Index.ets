import llmService from '../services/LlmService';
import ChatMessage from '../models/ChatMessage';

@Entry
@Component
struct Index {
  @State inputText: string = '';
  @State title: string = 'æ™ºèƒ½èŠå¤©åŠ©æ‰‹';
  @State isLoading: boolean = false;
  @State errorMessage: string = '';
  @State chatMessages: ChatMessage[] = [];
  @State showChat: boolean = false;

  build() {
    Column() {
      // æ ‡é¢˜åŒºåŸŸ
      Text(this.title)
        .id('Title')
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 20, bottom: 20 })

      if (!this.showChat) {
        // é¦–é¡µæœç´¢ç•Œé¢
        Column() {
          // ä½¿ç”¨æ–‡æœ¬æ›¿ä»£å›¾æ ‡
          Text('ğŸ¤–')
            .fontSize(80)
            .margin({ top: 80, bottom: 40 })

          Text('ä¸æ™ºèƒ½åŠ©æ‰‹å¯¹è¯')
            .fontSize(24)
            .fontWeight(FontWeight.Medium)
            .margin({ bottom: 60 })

          Row() {
            TextInput({ placeholder: 'è¯·è¾“å…¥æ‚¨çš„é—®é¢˜...' })
              .width('70%')
              .height(50)
              .borderRadius(25)
              .backgroundColor('#f5f5f5')
              .padding({ left: 20, right: 20 })
              .onChange((value: string) => {
                this.inputText = value;
              })

            Button() {
              Row() {
                if (this.isLoading) {
                  LoadingProgress()
                    .width(20)
                    .height(20)
                    .color(Color.White)
                } else {
                  Text('å‘é€')
                    .fontColor(Color.White)
                }
              }
            }
            .width('15%')
            .height(50)
            .borderRadius(25)
            .backgroundColor('#1976D2')
            .margin({ left: 10 })
            .onClick(() => {
              this.sendMessage();
            })
          }
          .width('90%')
          .justifyContent(FlexAlign.Center)
        }
        .width('100%')
        .height('100%')
        .justifyContent(FlexAlign.Start)
        .alignItems(HorizontalAlign.Center)
      } else {
        // èŠå¤©ç•Œé¢
        Column() {
          // èŠå¤©æ¶ˆæ¯åŒºåŸŸ
          Scroll() {
            Column() {
              ForEach(this.chatMessages, (message: ChatMessage) => {
                // æ ¹æ®æ¶ˆæ¯ç±»å‹æ˜¾ç¤ºä¸åŒæ ·å¼
                if (message.type === 'user') {
                  // ç”¨æˆ·æ¶ˆæ¯ - å·¦ä¾§
                  Row() {
                    Column() {
                      Text(message.content)
                        .fontSize(16)
                        .backgroundColor('#DCF8C6')
                        .padding(15)
                        .borderRadius(10)
                        .width('100%')
                    }
                    .alignItems(HorizontalAlign.Start)
                    .width('80%')
                  }
                  .width('100%')
                  .justifyContent(FlexAlign.Start)
                  .margin({ top: 10, bottom: 10 })
                } else {
                  // AIå›å¤ - å³ä¾§
                  Row() {
                    Column() {
                      Text(message.content)
                        .fontSize(16)
                        .backgroundColor('#EAEAEA')
                        .padding(15)
                        .borderRadius(10)
                        .width('100%')
                    }
                    .alignItems(HorizontalAlign.Start)
                    .width('80%')
                  }
                  .width('100%')
                  .justifyContent(FlexAlign.End)
                  .margin({ top: 10, bottom: 10 })
                }
              })

              // åŠ è½½ä¸­æŒ‡ç¤ºå™¨
              if (this.isLoading) {
                Row() {
                  LoadingProgress()
                    .width(24)
                    .height(24)
                    .color('#1976D2')
                  Text('æ­£åœ¨æ€è€ƒ...')
                    .fontSize(14)
                    .fontColor('#666666')
                    .margin({ left: 10 })
                }
                .width('100%')
                .justifyContent(FlexAlign.Start)
                .padding({ left: 20 })
                .margin({ top: 10, bottom: 10 })
              }
            }
            .width('90%')
            .padding(10)
          }
          .scrollBar(BarState.Auto)
          .scrollBarColor(Color.Gray)
          .scrollBarWidth(4)
          .edgeEffect(EdgeEffect.Spring)
          .width('100%')
          .height('85%')

          // é”™è¯¯ä¿¡æ¯æ˜¾ç¤º
          if (this.errorMessage !== '') {
            Text(this.errorMessage)
              .fontSize(14)
              .fontColor(Color.Red)
              .width('90%')
              .margin({ top: 5, bottom: 5 })
          }

          // åº•éƒ¨è¾“å…¥åŒº
          Row() {
            TextInput({ placeholder: 'è¾“å…¥æ¶ˆæ¯...' })
              .width('75%')
              .height(50)
              .borderRadius(25)
              .backgroundColor('#f5f5f5')
              .padding({ left: 20, right: 20 })
              .onChange((value: string) => {
                this.inputText = value;
              })

            Button() {
              Row() {
                if (this.isLoading) {
                  LoadingProgress()
                    .width(20)
                    .height(20)
                    .color(Color.White)
                } else {
                  Text('å‘é€')
                    .fontColor(Color.White)
                }
              }
            }
            .width('15%')
            .height(50)
            .borderRadius(25)
            .backgroundColor('#1976D2')
            .margin({ left: 10 })
            .onClick(() => {
              this.sendMessage();
            })
          }
          .width('90%')
          .justifyContent(FlexAlign.Center)
          .margin({ top: 10 })
        }
        .width('100%')
        .height('100%')
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#ffffff')
  }

  /**
   * å‘é€æ¶ˆæ¯å¹¶è·å–AIå›å¤
   */
  async sendMessage() {
    if (this.inputText.trim() === '') {
      this.errorMessage = 'è¯·è¾“å…¥æ¶ˆæ¯';
      return;
    }

    try {
      // è®¾ç½®çŠ¶æ€
      this.isLoading = true;
      this.errorMessage = '';
      
      // åˆ›å»ºç”¨æˆ·æ¶ˆæ¯
      const userMessage = new ChatMessage(this.inputText, 'user');
      
      // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œåˆ‡æ¢åˆ°èŠå¤©ç•Œé¢
      if (this.chatMessages.length === 0) {
        this.showChat = true;
      }
      
      // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
      this.chatMessages.push(userMessage);
      
      // æ¸…ç©ºè¾“å…¥æ¡†
      this.inputText = '';

      // è°ƒç”¨LLMæœåŠ¡
      const response = await llmService.queryLlm(userMessage.content);
      
      // åˆ›å»ºAIå›å¤æ¶ˆæ¯
      const aiMessage = new ChatMessage(response, 'assistant');
      
      // æ·»åŠ AIå›å¤
      this.chatMessages.push(aiMessage);
    } catch (error) {
      this.errorMessage = `æŸ¥è¯¢å¤±è´¥: ${error}`;
      console.error(`LLMæŸ¥è¯¢å¤±è´¥: ${error}`);
    } finally {
      this.isLoading = false;
    }
  }
}